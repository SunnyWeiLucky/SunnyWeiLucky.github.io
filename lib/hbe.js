(()=>{"use strict";const c=window.crypto||window.msCrypto,a=window.localStorage,l="hexo-blog-encrypt:#"+window.location.pathname,i=p("hexo-blog-encrypt的作者们都是大帅比!"),s=p("hexo-blog-encrypt是地表最强Hexo加密插件!"),d="<hbe-prefix></hbe-prefix>",e=document.getElementById("hexo-blog-encrypt"),r=e.dataset.wpm,y=e.dataset.whm;var n,o,t,u=e.getElementsByTagName("script").hbeData;const h=u.innerText,m=u.dataset.hmacdigest;function g(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function p(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):127<a&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):2047<a&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}async function f(e){let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await async function(t){let n=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(e=>{t[e]&&(n[e]=t[e])}),n}(e))}),t}async function w(e,t,i){var n=g(h);return await c.subtle.decrypt({name:"AES-CBC",iv:t},e,n.buffer).then(async e=>{const t=new TextDecoder,n=t.decode(e);if(!n.startsWith(d))throw"Decode successfully but not start with KnownPrefix.";const r=document.createElement("button");r.textContent="Encrypt again",r.type="button",r.classList.add("hbe-button"),r.addEventListener("click",()=>{window.localStorage.removeItem(l),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await f(n)),document.getElementById("hexo-blog-encrypt").appendChild(r),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))}),window.NexT&&NexT.boot&&"function"==typeof NexT.boot.refresh&&NexT.boot.refresh();e=document.getElementById("toc-div");e&&(e.style.display="inline");var o=document.getElementsByClassName("toc-div-class");if(o&&0<o.length)for(var a=0;a<o.length;a++)o[a].style.display="inline";return await async function(e,t){const n=new TextEncoder;var r=n.encode(t),t=g(m),r=await c.subtle.verify({name:"HMAC",hash:"SHA-256"},e,t,r);return console.log(`Verification result: ${r}`),r||(alert(y),console.log(`${y}, got `,t," but proved wrong.")),r}(i,n)}).catch(e=>(alert(r),console.log(e),!1))}(t=JSON.parse(a.getItem(l)))&&(console.log(`Password got from localStorage(${l}): `,t),n=g(t.iv).buffer,u=t.dk,o=t.hmk,c.subtle.importKey("jwk",u,{name:"AES-CBC",length:256},!0,["decrypt"]).then(t=>{c.subtle.importKey("jwk",o,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{w(t,n,e).then(e=>{e||a.removeItem(l)})})})),e.addEventListener("keydown",async e=>{var n,t,r,o;!e.isComposing&&13!==e.keyCode||(o=await function(e){let t=new TextEncoder;return c.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}(document.getElementById("hbePass").value),e=o,n=await c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:i.buffer,iterations:1024},e,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]),e=o,t=await c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:i.buffer,iterations:1024},e,{name:"AES-CBC",length:256},!0,["decrypt"]),o=o,r=await c.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:s.buffer,iterations:512},o,128),w(t,r,n).then(e=>{console.log(`Decrypt result: ${e}`),e&&c.subtle.exportKey("jwk",t).then(t=>{c.subtle.exportKey("jwk",n).then(e=>{e={dk:t,iv:function(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}(r),hmk:e};a.setItem(l,JSON.stringify(e))})})}))})})();